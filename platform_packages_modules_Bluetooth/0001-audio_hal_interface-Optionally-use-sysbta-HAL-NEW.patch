From 8f13b125f8772655ed96093ae19b88dd8d527083 Mon Sep 17 00:00:00 2001
From: harvey186 <harvey186@hotmail.com>
Date: Wed, 3 Dec 2025 16:29:55 +0100
Subject: [PATCH] audio_hal_interface-Optionally-use-sysbta-HAL-NEW

Change-Id: I4f455f35d0ec3bef2b7b562a0d697c684f4b8bba
---
 ..._interface-Optionally-use-sysbta-HAL.patch | 192 ++++++++++++++++++
 ...tatus-UNSUPPORTED_REMOTE_OR_LMP_FEAT.patch |  32 +++
 ...n-to-change-eSCO-Transport-Unit-Size.patch |  45 ++++
 ...en-failing-to-get-real-time-priority.patch |  85 ++++++++
 ...es-we-need-to-tell-Audio-HAL-if-we-r.patch |  70 +++++++
 ...o-disable-some-features-commands-sta.patch | 132 ++++++++++++
 ...o-cap-declared-le-vendor-version.-Fo.patch |  58 ++++++
 ...mmand-READ_REMOTE_VERSION_INFORMATIO.patch |  33 +++
 .../aidl/a2dp/client_interface_aidl.cc        |   8 +-
 .../aidl/a2dp/client_interface_aidl.h         |   7 +
 .../aidl/client_interface_aidl.cc             |   8 +-
 .../aidl/client_interface_aidl.h              |   7 +
 .../hal_version_manager.cc                    |  11 +-
 13 files changed, 678 insertions(+), 10 deletions(-)



diff --git a/system/audio_hal_interface/aidl/a2dp/client_interface_aidl.cc b/system/audio_hal_interface/aidl/a2dp/client_interface_aidl.cc
index 201cae8..ec238d5 100644
--- a/system/audio_hal_interface/aidl/a2dp/client_interface_aidl.cc
+++ b/system/audio_hal_interface/aidl/a2dp/client_interface_aidl.cc
@@ -59,7 +59,7 @@ BluetoothAudioClientInterface::~BluetoothAudioClientInterface() {
 bool BluetoothAudioClientInterface::IsValid() const { return provider_ != nullptr; }

 bool BluetoothAudioClientInterface::is_aidl_available() {
-  return AServiceManager_isDeclared(kDefaultAudioProviderFactoryInterface.c_str());
+  return AServiceManager_isDeclared(audioProviderFactoryInterface().c_str());
 }

 std::vector<AudioCapabilities> BluetoothAudioClientInterface::GetAudioCapabilities() const {
@@ -73,7 +73,7 @@ std::vector<AudioCapabilities> BluetoothAudioClientInterface::GetAudioCapabiliti
     return capabilities;
   }
   auto provider_factory = IBluetoothAudioProviderFactory::fromBinder(::ndk::SpAIBinder(
-          AServiceManager_waitForService(kDefaultAudioProviderFactoryInterface.c_str())));
+          AServiceManager_waitForService(audioProviderFactoryInterface().c_str())));

   if (provider_factory == nullptr) {
     log::error("can't get capability from unknown factory");
@@ -98,7 +98,7 @@ BluetoothAudioClientInterface::GetProviderInfo(

   if (provider_factory == nullptr) {
     provider_factory = IBluetoothAudioProviderFactory::fromBinder(::ndk::SpAIBinder(
-            AServiceManager_waitForService(kDefaultAudioProviderFactoryInterface.c_str())));
+            AServiceManager_waitForService(audioProviderFactoryInterface().c_str())));
   }

   if (provider_factory == nullptr) {
@@ -174,7 +174,7 @@ void BluetoothAudioClientInterface::FetchAudioProvider() {
   // re-registered, so we need to re-fetch the service.
   for (int retry_no = 0; retry_no < kFetchAudioProviderRetryNumber; ++retry_no) {
     auto provider_factory = IBluetoothAudioProviderFactory::fromBinder(::ndk::SpAIBinder(
-            AServiceManager_waitForService(kDefaultAudioProviderFactoryInterface.c_str())));
+            AServiceManager_waitForService(audioProviderFactoryInterface().c_str())));

     if (provider_factory == nullptr) {
       log::error("can't get capability from unknown factory");
diff --git a/system/audio_hal_interface/aidl/a2dp/client_interface_aidl.h b/system/audio_hal_interface/aidl/a2dp/client_interface_aidl.h
index e492fde..a24ffef 100644
--- a/system/audio_hal_interface/aidl/a2dp/client_interface_aidl.h
+++ b/system/audio_hal_interface/aidl/a2dp/client_interface_aidl.h
@@ -28,6 +28,7 @@
 #include "bta/le_audio/broadcaster/broadcaster_types.h"
 #include "bta/le_audio/le_audio_types.h"
 #include "transport_instance.h"
+#include "osi/include/properties.h"

 // Keep after audio_aidl_interfaces.h because of <base/logging.h>
 // conflicting definitions.
@@ -164,6 +165,12 @@ protected:
   //     "android.hardware.bluetooth.audio.IBluetoothAudioProviderFactory/default";
   static inline const std::string kDefaultAudioProviderFactoryInterface =
           std::string() + IBluetoothAudioProviderFactory::descriptor + "/default";
+  static inline const std::string kSystemAudioProviderFactoryInterface =
+          std::string() + IBluetoothAudioProviderFactory::descriptor + "/sysbta";
+  static inline const std::string audioProviderFactoryInterface() {
+      return osi_property_get_bool("persist.bluetooth.system_audio_hal.enabled", false)
+       ? kSystemAudioProviderFactoryInterface : kDefaultAudioProviderFactoryInterface;
+  }

 private:
   IBluetoothTransportInstance* transport_;
diff --git a/system/audio_hal_interface/aidl/client_interface_aidl.cc b/system/audio_hal_interface/aidl/client_interface_aidl.cc
index c1ce661..401fd5b 100644
--- a/system/audio_hal_interface/aidl/client_interface_aidl.cc
+++ b/system/audio_hal_interface/aidl/client_interface_aidl.cc
@@ -73,7 +73,7 @@ BluetoothAudioClientInterface::BluetoothAudioClientInterface(IBluetoothTransport
 bool BluetoothAudioClientInterface::IsValid() const { return provider_ != nullptr; }

 bool BluetoothAudioClientInterface::is_aidl_available() {
-  return AServiceManager_isDeclared(kDefaultAudioProviderFactoryInterface.c_str());
+  return AServiceManager_isDeclared(audioProviderFactoryInterface().c_str());
 }

 std::vector<AudioCapabilities> BluetoothAudioClientInterface::GetAudioCapabilities() const {
@@ -87,7 +87,7 @@ std::vector<AudioCapabilities> BluetoothAudioClientInterface::GetAudioCapabiliti
     return capabilities;
   }
   auto provider_factory = IBluetoothAudioProviderFactory::fromBinder(::ndk::SpAIBinder(
-          AServiceManager_waitForService(kDefaultAudioProviderFactoryInterface.c_str())));
+          AServiceManager_waitForService(audioProviderFactoryInterface().c_str())));

   if (provider_factory == nullptr) {
     log::error("can't get capability from unknown factory");
@@ -112,7 +112,7 @@ BluetoothAudioClientInterface::GetProviderInfo(

   if (provider_factory == nullptr) {
     provider_factory = IBluetoothAudioProviderFactory::fromBinder(::ndk::SpAIBinder(
-            AServiceManager_waitForService(kDefaultAudioProviderFactoryInterface.c_str())));
+            AServiceManager_waitForService(audioProviderFactoryInterface().c_str())));
   }

   if (provider_factory == nullptr) {
@@ -144,7 +144,7 @@ void BluetoothAudioClientInterface::FetchAudioProvider() {
   // re-registered, so we need to re-fetch the service.
   for (int retry_no = 0; retry_no < kFetchAudioProviderRetryNumber; ++retry_no) {
     auto provider_factory = IBluetoothAudioProviderFactory::fromBinder(::ndk::SpAIBinder(
-            AServiceManager_waitForService(kDefaultAudioProviderFactoryInterface.c_str())));
+            AServiceManager_waitForService(audioProviderFactoryInterface().c_str())));

     if (provider_factory == nullptr) {
       log::error("can't get capability from unknown factory");
diff --git a/system/audio_hal_interface/aidl/client_interface_aidl.h b/system/audio_hal_interface/aidl/client_interface_aidl.h
index a3c6038..ee5901e 100644
--- a/system/audio_hal_interface/aidl/client_interface_aidl.h
+++ b/system/audio_hal_interface/aidl/client_interface_aidl.h
@@ -29,6 +29,7 @@
 #include "bta/le_audio/broadcaster/broadcaster_types.h"
 #include "bta/le_audio/le_audio_types.h"
 #include "transport_instance.h"
+#include "osi/include/properties.h"

 namespace bluetooth {
 namespace audio {
@@ -150,6 +151,12 @@ protected:
   //     "android.hardware.bluetooth.audio.IBluetoothAudioProviderFactory/default";
   static inline const std::string kDefaultAudioProviderFactoryInterface =
           std::string() + IBluetoothAudioProviderFactory::descriptor + "/default";
+  static inline const std::string kSystemAudioProviderFactoryInterface =
+          std::string() + IBluetoothAudioProviderFactory::descriptor + "/sysbta";
+  static inline const std::string audioProviderFactoryInterface() {
+      return osi_property_get_bool("persist.bluetooth.system_audio_hal.enabled", false)
+       ? kSystemAudioProviderFactoryInterface : kDefaultAudioProviderFactoryInterface;
+  }

 private:
   IBluetoothTransportInstance* transport_;
diff --git a/system/audio_hal_interface/hal_version_manager.cc b/system/audio_hal_interface/hal_version_manager.cc
index 1a92c1a..bb27167 100644
--- a/system/audio_hal_interface/hal_version_manager.cc
+++ b/system/audio_hal_interface/hal_version_manager.cc
@@ -20,6 +20,7 @@
 #include <android/hidl/manager/1.2/IServiceManager.h>
 #include <bluetooth/log.h>
 #include <hidl/ServiceManagement.h>
+#include "osi/include/properties.h"

 #include <memory>
 #include <mutex>
@@ -34,6 +35,12 @@ using ::aidl::android::hardware::bluetooth::audio::IBluetoothAudioProviderFactor

 static const std::string kDefaultAudioProviderFactoryInterface =
         std::string() + IBluetoothAudioProviderFactory::descriptor + "/default";
+static const std::string kSystemAudioProviderFactoryInterface =
+        std::string() + IBluetoothAudioProviderFactory::descriptor + "/sysbta";
+static inline const std::string audioProviderFactoryInterface() {
+    return osi_property_get_bool("persist.bluetooth.system_audio_hal.enabled", false)
+     ? kSystemAudioProviderFactoryInterface : kDefaultAudioProviderFactoryInterface;
+}

 std::string toString(BluetoothAudioHalTransport transport) {
   switch (transport) {
@@ -74,7 +81,7 @@ BluetoothAudioHalVersion GetAidlInterfaceVersion() {
   static auto aidl_version = []() -> BluetoothAudioHalVersion {
     int version = 0;
     auto provider_factory = IBluetoothAudioProviderFactory::fromBinder(::ndk::SpAIBinder(
-            AServiceManager_waitForService(kDefaultAudioProviderFactoryInterface.c_str())));
+            AServiceManager_waitForService(audioProviderFactoryInterface().c_str())));

     if (provider_factory == nullptr) {
       log::error("getInterfaceVersion: Can't get aidl version from unknown factory");
@@ -139,7 +146,7 @@ android::sp<IBluetoothAudioProvidersFactory_2_0> HalVersionManager::GetProviders

 HalVersionManager::HalVersionManager() {
   hal_transport_ = BluetoothAudioHalTransport::UNKNOWN;
-  if (AServiceManager_checkService(kDefaultAudioProviderFactoryInterface.c_str()) != nullptr) {
+  if (AServiceManager_checkService(audioProviderFactoryInterface().c_str()) != nullptr) {
     hal_version_ = GetAidlInterfaceVersion();
     hal_transport_ = BluetoothAudioHalTransport::AIDL;
     return;
--
2.34.1
